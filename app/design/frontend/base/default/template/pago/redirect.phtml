<?php
$order = new Mage_Sales_Model_Order();


//Credenciales
$codComercio = Mage::getStoreConfig( 'payment/pago/codigo_comercio' );
$keyComercio = Mage::getStoreConfig( 'payment/pago/llave_codigo_comercio' );


$checkout = Mage::getSingleton('checkout/session');
$orderId =  $checkout->getLastRealOrderId();


// Obteniendo Data
$order = Mage::getModel('sales/order')->loadByIncrementId($orderId);
$currency   = $order->getOrderCurrencyCode();
$BAddress = $order->getBillingAddress();

$Address = $order->getShippingAddress()->getStreet1().' '.$order->getShippingAddress()->getStreet2();

$CustomerName = $BAddress->getFirstname();
$CustomerLastName = $BAddress->getLastname();
$CustomerID = $orderId;
$CustomerEmail = $order->getCustomerEmail();

$Total = number_format($order->getGrandTotal(),2,'','');

$city = $BAddress->getCity();
$telephone = $BAddress->getTelephone();

$codPais = 'PE';

$ProductName = '';
$items = $order->getAllItems();
if ($items)
  {
      foreach($items as $item)
      {
        if ($item->getParentItem()) continue;
  $ProductName .= $item->getName() . '; ';
      }
  }
$ProductName = rtrim($ProductName, '; ');




$informacionVentaCifrada = Mage::registry('informacion_venta');



?>
<h2><?php echo $this->__('Venta Creada con Culqi') ?></h2>
<p>Bien ¡Venta creada!. Ahora debes proceder a pagar,
  se abrira una ventana modal donde deberás ingresar tu información de tarjeta.</p><br>

Numero de orden: <?php echo $orderId; ?> <br>

Descripción: <?php echo $ProductName; ?> <br>
Nombres: <?php echo $CustomerName; ?> <br>
Apellidos: <?php echo $CustomerLastName; ?> <br>
Direccion: <?php echo $Address ?> <br>
Ciudad: <?php echo $city; ?> <br>
Telefono: <?php echo $telephone; ?> <br>
Monto: <?php echo $Total; ?> <br>
Email: <?php echo $CustomerEmail; ?> <br>
Moneda  <?php echo $currency; ?> <br>
País:  <?php echo $codPais; ?> <br>


<!--<form name="pago" method="post" action="<?php echo Mage::helper('pago')->getPaymentGatewayUrl(); ?>">
  <input type="hidden" name="orderId" value="<?php echo $orderId; ?>">
  <input type="submit" value="<?php echo $this->__('Pagar') ?>" />
</form>-->

<!-- Botón de pago de Culqi -->
        <button id="btn_pago">Pagar</button>

        <p id="notify"></p>

        <script src="https://integ-pago.culqi.com/api/v1/culqi.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>


        <!-- De culqi-helpers.js -->
        <script>
        /**
        * EnvÃ­a un string en formato JSON con el mÃ©todo POST
        *
        * @param string url
        * @param string data
        * @param function success (optional)
        * @return object
        */
        function PostData(url, data, success)
        {
          // Devuelve la respuesta del servidor luego de enviarse la peticiÃ³n
          this.respuesta = function () {
            return xhttp.responseText;
          };
          // Si success no estÃ¡ definido, se le da un valor de undefined
          success = success || undefined;
          // Se crea una peticiÃ³n que serÃ¡ enviada a la url
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (xhttp.readyState == 4 && xhttp.status == 200) {
              console.log('InformaciÃ³n enviada al servidor.');
              if (!(success === undefined)) {
                success();
              }
            }
          };
          // Define el mÃ©todo de envÃ­o y envÃ­a los datos
          xhttp.open('POST', url, true);
          xhttp.send(data);
        }

        /**
        * EnvÃ­a una peticiÃ³n POST con informaciÃ³n y redirige a la url
        *
        * @param string url
        * @param string json
        */
        function post(url, json)
        {
          // Convertimos el json en un objeto
          var obj = JSON.parse(json);
          // Creamos un array con los nombres de las propiedades del objeto
          var objKeys = Object.keys(obj);
          // Creamos elementos <input> con el name=clave y value=valor del objeto
          var inputs = [];
          for (i = 0; i < objKeys.length; i++) {
            inputs[i] = document.createElement('INPUT');
            inputs[i].name = objKeys[i];
            inputs[i].value = obj[objKeys[i]];
          }

          var form = document.createElement('FORM');
          form.action = url;
          form.method = 'post';

          for (i = 0; i < objKeys.length; i++) {
            form.appendChild(inputs[i]);
          }

          form.submit();
        }

        </script>


        <!-- Aquí configuramos el botón de pago de Culqi. -->
        <script>

         var intentos = 3;

        // Código del comercio
        checkout.codigo_comercio = '<?= $codComercio ?>';
        // La informacion_venta es el contenido del parámetro que recibiste en la creación de la venta.
        checkout.informacion_venta = '<?= $informacionVentaCifrada ?>';
        // Activa el botón de pago, al darle click mostrará el formulario de pago
        document.getElementById('btn_pago').addEventListener('click', function (e) {
            checkout.abrir();
            e.preventDefault();
        });
        // Esta función es llamada al terminar el proceso de pago.
        // Debe de ser usada siempre, para poder obtener la respuesta.
        function culqi(checkout)
        {
            // Aquí recibes la respuesta del formulario de pago.
            // Si el usuario cierra el formulario de pago: checkout.respuesta tendrá en valor "checkout_cerrado"
            console.log(checkout.respuesta);

            // Cierra el formulario de pago de Culqi.
            checkout.cerrar();

            // // Estados
            // if (checkout.respuesta != "checkout_cerrado" &&
            // checkout.respuesta != "venta_expirada" &&
            // checkout.respuesta != "error" &&
            // checkout.respuesta != "parametro_invalido")
            // {
            //   // Venta exitosa
            // post(' ', json);
            //
            //     if (obj.trnEstado == "venta_exitosa") {
            //
            //       $('#notify').empty();
            //
            //       // $.ajax({
            //       //   url: "/index.php?wc-api=WC_culqi",
            //       //   type: "POST",
            //       //   data: {emptyCart: 1},
            //       //   success: function (data) {
            //       //     // console.log(data);
            //       //   }
            //       // });
            //     }
            //     else {
            //       intentos--;
            //
            //
            //       if (intentos == 0) {
            //         $('#notify').html("");
            //         $('#notify').html("<span><strong>" + obj.mensajeRespuesta + "</strong></span><br>" +
            //         "<br><span>Superaste el número de intentos.<br></span><button id='refresh'>Regresar</button>");
            //       } else if (intentos == 1) {
            //         $('#notify').html("");
            //         $('#notify').html("<strong>" + obj.mensajeRespuesta + "</strong><br><br>");
            //       } else {
            //         $('#notify').html("");
            //         $('#notify').html("<strong>" + obj.mensajeRespuesta + "</strong><br><br>");
            //       }
            //     }
            //
            //
            // }
            //




            if (checkout.respuesta == "checkout_cerrado") {
              $('#notify').html("");
              $('#notify').html("<strong>" + "Cerraste el formulario de pago, para volver a la compra clica en Pagar" + "</strong><br><br>");
            }

            if (checkout.respuesta == "error" || checkout.respuesta == "parametro_invalido") {

              $('#notify').html("");
              $('#notify').html("<span><strong>" + "Ocurrió un error inesperado, regresa al paso anterior para que puedas terminar la compra." + "</strong></span><br>" +
              "<br><span><br></span><button id='refresh'>Regresar</button>");

            }





            // Envía la respuesta cifrada que recibiste del formulario de Culqi a tu
            // servidor para descifrarlo, tu servidor lo descifra con la librería
            // de culqi y con esos datos muestra la vista de venta realizada
            var json = JSON.stringify({
                informacionDeVentaCifrada: checkout.respuesta,
                orderId: '<?php echo $orderId; ?>'

            });

            // Venta exitosa
            post('<?php echo Mage::helper('pago')->getPaymentGatewayUrl(); ?>', json);

        };
        </script>
